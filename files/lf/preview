#!/usr/bin/env bash
# =============================================================================
# lf Previewer Script
# =============================================================================
# Dependencies: file, bat, chafa, ffmpegthumbnailer, pdftoppm, mediainfo
# =============================================================================

file_path="$1"
width="$2"
height="$3"
x="$4"
y="$5"

case "$(file -Lb --mime-type "$file_path")" in
    # Text files
    text/* | */xml | application/json | application/javascript)
        if command -v bat &>/dev/null; then
            bat --color=always --style=plain --paging=never -l "${file_path##*.}" "$file_path"
        else
            cat "$file_path"
        fi
        ;;
    
    # Images
    image/*)
        if command -v chafa &>/dev/null; then
            chafa -f sixel -s "${width}x${height}" "$file_path"
        else
            file -b "$file_path"
        fi
        ;;
    
    # Video
    video/*)
        if command -v ffmpegthumbnailer &>/dev/null; then
            cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/lf"
            mkdir -p "$cache_dir"
            thumb="$cache_dir/$(stat --printf '%n%i%F%s%W%Y' -- "$(readlink -f "$file_path")" | sha256sum | awk '{print $1}').jpg"
            [ -f "$thumb" ] || ffmpegthumbnailer -i "$file_path" -o "$thumb" -s 0 -q 5
            if command -v chafa &>/dev/null; then
                chafa -f sixel -s "${width}x${height}" "$thumb"
            fi
        fi
        if command -v mediainfo &>/dev/null; then
            mediainfo "$file_path"
        fi
        ;;
    
    # Audio
    audio/*)
        if command -v mediainfo &>/dev/null; then
            mediainfo "$file_path"
        else
            file -b "$file_path"
        fi
        ;;
    
    # PDF
    application/pdf)
        if command -v pdftoppm &>/dev/null; then
            cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/lf"
            mkdir -p "$cache_dir"
            thumb="$cache_dir/$(stat --printf '%n%i%F%s%W%Y' -- "$(readlink -f "$file_path")" | sha256sum | awk '{print $1}').jpg"
            [ -f "$thumb" ] || pdftoppm -jpeg -f 1 -singlefile "$file_path" "${thumb%.jpg}"
            if command -v chafa &>/dev/null; then
                chafa -f sixel -s "${width}x${height}" "$thumb"
            fi
        fi
        ;;
    
    # Archives
    application/zip | application/x-tar | application/x-gzip | application/x-bzip2 | application/x-xz | application/x-7z-compressed | application/x-rar)
        if command -v atool &>/dev/null; then
            atool -l "$file_path"
        elif command -v bsdtar &>/dev/null; then
            bsdtar -tf "$file_path"
        fi
        ;;
    
    # Fallback
    *)
        file -b "$file_path"
        ;;
esac

exit 0

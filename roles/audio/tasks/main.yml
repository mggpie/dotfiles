---
# =============================================================================
# Audio Role - PipeWire and Bluetooth
# =============================================================================

- name: Install PipeWire and audio packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ audio_packages | join(' ') }}"
  changed_when: true

- name: Install Bluetooth packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ bluetooth_packages | join(' ') }}"
  changed_when: true

- name: Enable PipeWire user service directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/systemd/user"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

# PipeWire runs as user service, started by compositor
- name: Create pipewire autostart script
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Start PipeWire audio server
      /usr/bin/pipewire &
      /usr/bin/pipewire-pulse &
      /usr/bin/wireplumber &
    dest: /usr/local/bin/start-audio.sh
    mode: '0755'

- name: Enable dbus service
  ansible.builtin.file:
    src: /etc/sv/dbus
    dest: /var/service/dbus
    state: link

- name: Enable bluetoothd service
  ansible.builtin.file:
    src: /etc/sv/bluetoothd
    dest: /var/service/bluetoothd
    state: link

- name: Configure bluetooth
  ansible.builtin.blockinfile:
    path: /etc/bluetooth/main.conf
    block: |
      [General]
      Enable=Source,Sink,Media,Socket
      Experimental=true
      
      [Policy]
      AutoEnable=true
    create: true
    mode: '0644'

- name: Add user to bluetooth group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: bluetooth
    append: true

- name: Create PipeWire config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/pipewire"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Install Bluetooth GUI (blueman)
  ansible.builtin.command:
    cmd: xbps-install -Sy blueman
  changed_when: true
  failed_when: false

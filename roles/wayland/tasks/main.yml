---
# =============================================================================
# Wayland Role - River WM and Desktop Environment
# =============================================================================

- name: Install wayland packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ wayland_packages | join(' ') }}"
  changed_when: true

# Seatd is required for River/Sway to access DRM/input devices
- name: Enable seatd service
  ansible.builtin.file:
    src: /etc/sv/seatd
    dest: /var/service/seatd
    state: link

- name: Add user to _seatd group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: _seatd
    append: true

- name: Create river config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/river"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Deploy river configuration
  ansible.builtin.template:
    src: river/init.j2
    dest: "{{ user_home }}/.config/river/init"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Create foot config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/foot"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Deploy foot configuration
  ansible.builtin.template:
    src: foot/foot.ini.j2
    dest: "{{ user_home }}/.config/foot/foot.ini"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Create waybar config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/waybar"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Deploy waybar configuration
  ansible.builtin.template:
    src: waybar/config.j2
    dest: "{{ user_home }}/.config/waybar/config"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Deploy waybar styles
  ansible.builtin.template:
    src: waybar/style.css.j2
    dest: "{{ user_home }}/.config/waybar/style.css"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Create kanshi config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/kanshi"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Deploy kanshi configuration
  ansible.builtin.template:
    src: kanshi/config.j2
    dest: "{{ user_home }}/.config/kanshi/config"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Create screenshot script
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Screenshot tool
      SCREENSHOT_DIR="{{ user_home }}/Pictures/Screenshots"
      mkdir -p "$SCREENSHOT_DIR"
      FILENAME="$SCREENSHOT_DIR/screenshot-$(date +%Y%m%d-%H%M%S).png"
      case "${1:-area}" in
          area)
              grim -g "$(slurp)" - | tee "$FILENAME" | wl-copy
              ;;
          full)
              grim - | tee "$FILENAME" | wl-copy
              ;;
      esac
      notify-send "Screenshot saved" "$FILENAME" 2>/dev/null || true
    dest: /usr/local/bin/screenshot.sh
    mode: '0755'

- name: Install clipboard manager (cliphist)
  ansible.builtin.command:
    cmd: xbps-install -Sy cliphist
  changed_when: true
  failed_when: false

- name: Create swaylock config directory
  ansible.builtin.file:
    path: "{{ user_home }}/.config/swaylock"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Setup swaylock configuration
  ansible.builtin.copy:
    content: |
      color={{ colors.base }}
      inside-color={{ colors.base }}
      inside-clear-color={{ colors.green }}
      inside-ver-color={{ colors.blue }}
      inside-wrong-color={{ colors.red }}
      key-hl-color={{ colors.mauve }}
      ring-color={{ colors.surface0 }}
      ring-clear-color={{ colors.green }}
      ring-ver-color={{ colors.blue }}
      ring-wrong-color={{ colors.red }}
      text-color={{ colors.text }}
    dest: "{{ user_home }}/.config/swaylock/config"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

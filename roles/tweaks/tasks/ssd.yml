---
# =============================================================================
# SSD and TRIM Configuration
# =============================================================================

- name: Install util-linux for fstrim
  ansible.builtin.command:
    cmd: xbps-install -Sy util-linux
  changed_when: true

- name: Check if running on LUKS
  ansible.builtin.stat:
    path: /dev/mapper/voidcrypt
  register: luks_device

# Enable discard for LUKS (with security awareness)
# Note: User is aware of security implications
- name: Configure crypttab for discard
  ansible.builtin.lineinfile:
    path: /etc/crypttab
    regexp: '^voidcrypt'
    line: 'voidcrypt UUID={{ luks_uuid }} none luks,discard'
    create: true
    mode: '0644'
  when:
    - luks_device.stat.exists
    - luks_uuid is defined
    - luks_uuid | length > 0

# Regenerate initramfs to apply changes
- name: Update dracut for discard support
  ansible.builtin.copy:
    content: |
      # Enable TRIM/discard for LUKS
      add_dracutmodules+=" crypt dm rootfs-block "
      install_items+=" /etc/crypttab "
    dest: /etc/dracut.conf.d/10-crypt.conf
    mode: '0644'

- name: Regenerate initramfs
  ansible.builtin.command:
    cmd: dracut --force
  changed_when: true
  ignore_errors: true

# fstrim is handled by cron job in base role
- name: Verify fstrim is available
  ansible.builtin.command:
    cmd: which fstrim
  register: fstrim_check
  changed_when: false
  failed_when: fstrim_check.rc != 0

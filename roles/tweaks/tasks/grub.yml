---
# =============================================================================
# GRUB Configuration with Performance Tweaks
# =============================================================================

- name: Get LUKS UUID from existing GRUB config
  ansible.builtin.shell: |
    grep -oP 'rd\.luks\.uuid=\K[a-f0-9-]+' /etc/default/grub 2>/dev/null || \
    blkid -t TYPE=crypto_LUKS -s UUID -o value | head -1
  register: luks_uuid_result
  changed_when: false
  failed_when: false

- name: Set LUKS UUID fact
  ansible.builtin.set_fact:
    luks_uuid: "{{ luks_uuid_result.stdout | default('') }}"

- name: Debug LUKS UUID
  ansible.builtin.debug:
    msg: "LUKS UUID detected: {{ luks_uuid }}"

- name: Configure GRUB
  ansible.builtin.template:
    src: grub.j2
    dest: /etc/default/grub
    mode: '0644'
    backup: true
  notify: Regenerate GRUB

- name: Regenerate GRUB configuration
  ansible.builtin.command:
    cmd: grub-mkconfig -o /boot/grub/grub.cfg
  changed_when: true

---
# =============================================================================
# Power Management with TLP
# =============================================================================

- name: Install TLP and dependencies
  ansible.builtin.command:
    cmd: xbps-install -Sy {{ power_packages | join(' ') }}
  changed_when: true

- name: Deploy TLP configuration
  ansible.builtin.copy:
    content: |
      # =============================================================================
      # TLP Power Management Configuration
      # =============================================================================

      # Enable TLP
      TLP_ENABLE=1
      TLP_DEFAULT_MODE=AC

      # CPU settings
      # Intel CPU - use intel_pstate driver
      CPU_SCALING_GOVERNOR_ON_AC=performance
      CPU_SCALING_GOVERNOR_ON_BAT=powersave

      # Boost
      CPU_BOOST_ON_AC=1
      CPU_BOOST_ON_BAT=0

      # Energy vs Performance (Intel)
      CPU_ENERGY_PERF_POLICY_ON_AC=performance
      CPU_ENERGY_PERF_POLICY_ON_BAT=balance_power

      # Disk
      DISK_IDLE_SECS_ON_AC=0
      DISK_IDLE_SECS_ON_BAT=2

      # SATA link power management
      SATA_LINKPWR_ON_AC="med_power_with_dipm max_performance"
      SATA_LINKPWR_ON_BAT="med_power_with_dipm min_power"

      # PCIe ASPM
      PCIE_ASPM_ON_AC=default
      PCIE_ASPM_ON_BAT=powersupersave

      # WiFi power saving
      WIFI_PWR_ON_AC=off
      WIFI_PWR_ON_BAT=on

      # USB autosuspend
      USB_AUTOSUSPEND=1

      # Exclude certain devices from USB autosuspend
      USB_EXCLUDE_BTUSB=1

      # Audio power saving
      SOUND_POWER_SAVE_ON_AC=0
      SOUND_POWER_SAVE_ON_BAT=1

      # Runtime PM for PCI(e) devices
      RUNTIME_PM_ON_AC=on
      RUNTIME_PM_ON_BAT=auto
    dest: /etc/tlp.conf
    mode: '0644'

- name: Enable TLP service
  ansible.builtin.file:
    src: /etc/sv/tlp
    dest: /var/service/tlp
    state: link
  ignore_errors: true

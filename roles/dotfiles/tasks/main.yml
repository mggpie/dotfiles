---
# =============================================================================
# Dotfiles Role - Symlink Management
# =============================================================================
# This role creates symlinks from dotfiles repo to ~/.config
# Making this repository the single source of truth for all configs
# =============================================================================

# Define symlinks to create
# Using loop for cleaner, more maintainable code

- name: Define dotfiles symlinks
  ansible.builtin.set_fact:
    dotfiles_symlinks:
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/mpv"
        dest: "{{ user_home }}/.config/mpv"
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/newsboat"
        dest: "{{ user_home }}/.config/newsboat"
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/zathura"
        dest: "{{ user_home }}/.config/zathura"
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/lf"
        dest: "{{ user_home }}/.config/lf"
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/qutebrowser"
        dest: "{{ user_home }}/.config/qutebrowser"
      - src: "{{ dotfiles_dir }}/roles/dotfiles/files/micro"
        dest: "{{ user_home }}/.config/micro"

- name: Ensure config directories exist
  ansible.builtin.file:
    path: "{{ user_home }}/.config"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

- name: Remove existing config directories/files (before symlinking)
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: absent
  loop: "{{ dotfiles_symlinks }}"
  loop_control:
    label: "{{ item.dest }}"

- name: Create dotfiles symlinks
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    owner: "{{ username }}"
    group: "{{ username }}"
    force: true
  loop: "{{ dotfiles_symlinks }}"
  loop_control:
    label: "{{ item.dest }}"

# Make scripts executable
- name: Make lf scripts executable
  ansible.builtin.file:
    path: "{{ item }}"
    mode: '0755'
  loop:
    - "{{ dotfiles_dir }}/roles/dotfiles/files/lf/preview"
    - "{{ dotfiles_dir }}/roles/dotfiles/files/lf/cleaner"
  failed_when: false

# Create local bin directory for scripts
- name: Create local bin directory
  ansible.builtin.file:
    path: "{{ user_home }}/.local/bin"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'

# Note: Templated configs (fish, foot, river, waybar, kanshi) are managed
# by their respective roles and NOT symlinked, as they need variable substitution

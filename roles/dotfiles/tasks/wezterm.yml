---
- name: Check if Nix is installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.nix-profile/etc/profile.d/nix.sh"
  register: dotfiles_nix_installed
  tags: [wezterm]

- name: Install Nix
  ansible.builtin.shell: |
    set -o pipefail
    curl -L https://nixos.org/nix/install | sh -s -- --no-daemon
  args:
    executable: /bin/bash
  when: not dotfiles_nix_installed.stat.exists
  changed_when: true
  tags: [wezterm]

- name: Add nixpkgs unstable channel
  ansible.builtin.shell: |
    . ~/.nix-profile/etc/profile.d/nix.sh
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
    nix-channel --update
  args:
    executable: /bin/bash
  when: not dotfiles_nix_installed.stat.exists
  changed_when: true
  tags: [wezterm]

- name: Install wezterm via Nix
  ansible.builtin.shell: |
    . ~/.nix-profile/etc/profile.d/nix.sh
    nix-env -iA nixpkgs.wezterm
  args:
    executable: /bin/bash
  changed_when: false
  tags: [wezterm]

- name: Create wezterm config directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/wezterm"
    state: directory
    mode: "0755"
  tags: [wezterm]

- name: Copy wezterm config
  ansible.builtin.copy:
    src: wezterm/wezterm.lua
    dest: "{{ ansible_env.HOME }}/.config/wezterm/wezterm.lua"
    mode: "0644"
  tags: [wezterm]

---
# Base system configuration

- name: Install base packages
  community.general.xbps:
    name:
      - chrony
      - opendoas
      - fontconfig
      - cronie
      - util-linux
      - elogind
      - dbus-elogind
      - polkit-elogind
      - xdg-user-dirs
      - xdg-utils
      - seatd
    state: present
  become: true
  tags: [base]

- name: Install CPU microcode
  community.general.xbps:
    name: "{{ 'intel-ucode' if cpu_vendor == 'intel' else 'linux-firmware-amd' }}"
    state: present
  become: true
  tags: [base]

- name: Configure doas
  ansible.builtin.copy:
    content: |
      permit nopass :wheel
    dest: /etc/doas.conf
    mode: "0400"
  become: true
  tags: [base]

- name: Set timezone
  ansible.builtin.file:
    src: "/usr/share/zoneinfo/{{ timezone }}"
    dest: /etc/localtime
    state: link
    force: true
  become: true
  tags: [base]

- name: Configure locale
  ansible.builtin.copy:
    content: "LANG={{ locale }}"
    dest: /etc/locale.conf
    mode: "0644"
  become: true
  tags: [base]

- name: Enable locale
  ansible.builtin.lineinfile:
    path: /etc/default/libc-locales
    regexp: "^#?{{ locale }}"
    line: "{{ locale }} UTF-8"
  become: true
  tags: [base]

- name: Regenerate locales
  ansible.builtin.command: xbps-reconfigure -f glibc-locales
  become: true
  changed_when: false
  tags: [base]

- name: Set keyboard layout
  ansible.builtin.copy:
    content: "KEYMAP={{ keymap }}"
    dest: /etc/vconsole.conf
    mode: "0644"
  become: true
  tags: [base]

- name: Configure auto-login on TTY1
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      exec /sbin/agetty --autologin {{ username }} --noclear tty1 linux
    dest: /etc/sv/agetty-tty1/run
    mode: "0755"
  become: true
  tags: [base]

- name: Disable TTY 3-6
  ansible.builtin.file:
    path: "/var/service/agetty-tty{{ item }}"
    state: absent
  loop: [3, 4, 5, 6]
  become: true
  tags: [base]

- name: Enable base services
  ansible.builtin.file:
    src: "/etc/sv/{{ item }}"
    dest: "/var/service/{{ item }}"
    state: link
  loop:
    - chronyd
    - dbus
    - elogind
    - seatd
    - cronie
  become: true
  tags: [base]

- name: SSH only on VMs
  ansible.builtin.file:
    path: /var/service/sshd
    state: "{{ 'link' if ansible_virtualization_role == 'guest' else 'absent' }}"
    src: "{{ '/etc/sv/sshd' if ansible_virtualization_role == 'guest' else omit }}"
    mode: "{{ '0777' if ansible_virtualization_role == 'guest' else omit }}"
  become: true
  tags: [base]

- name: Create XDG directories
  ansible.builtin.file:
    path: "{{ user_home }}/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - Desktop
    - Downloads
    - Documents
    - Music
    - Pictures
    - Videos
  tags: [base]

# Nix package manager

- name: Check if Nix is installed
  ansible.builtin.stat:
    path: "{{ user_home }}/.nix-profile/etc/profile.d/nix.sh"
  register: dotfiles_nix_installed
  tags: [base, nix]

- name: Install Nix
  ansible.builtin.shell: |
    set -o pipefail
    curl -L https://nixos.org/nix/install | sh -s -- --no-daemon
  args:
    executable: /bin/bash
  when: not dotfiles_nix_installed.stat.exists
  changed_when: true
  tags: [base, nix]

- name: Add nixpkgs unstable channel
  ansible.builtin.shell: |
    . ~/.nix-profile/etc/profile.d/nix.sh
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
    nix-channel --update
  args:
    executable: /bin/bash
  when: not dotfiles_nix_installed.stat.exists
  changed_when: true
  tags: [base, nix]

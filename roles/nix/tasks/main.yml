---
# =============================================================================
# Nix Package Manager and Flatpak Role
# =============================================================================

# Nix installation
- name: Check if Nix is installed
  ansible.builtin.stat:
    path: /nix
  register: nix_installed

- name: Install Nix package manager
  ansible.builtin.shell: |
    curl -L https://nixos.org/nix/install | sh -s -- --daemon --yes
  args:
    creates: /nix
  when: not nix_installed.stat.exists

- name: Add Nix channel (stable)
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
    nix-channel --update
  args:
    creates: "{{ user_home }}/.nix-channels"
  failed_when: false

- name: Install packages from Nix
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix-env -iA nixpkgs.{{ item }}
  loop:
    - vscode        # Microsoft VS Code
    - wezterm       # Latest wezterm
  failed_when: false

# Flatpak installation
- name: Install Flatpak
  ansible.builtin.command:
    cmd: xbps-install -Sy flatpak
  changed_when: true

- name: Add Flathub repository
  ansible.builtin.command:
    cmd: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
  changed_when: true
  failed_when: false

# Optional: Install some flatpak apps
# - name: Install Flatpak applications
#   ansible.builtin.command:
#     cmd: flatpak install -y flathub {{ item }}
#   loop:
#     - com.spotify.Client
#     - org.telegram.desktop
#   failed_when: false

- name: Create fish nix integration
  ansible.builtin.copy:
    content: |
      # Nix integration for fish shell
      if test -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.fish
          source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.fish
      end

      # Add nix profile to path
      if test -d ~/.nix-profile/bin
          set -gx PATH ~/.nix-profile/bin $PATH
      end
    dest: "{{ user_home }}/.config/fish/conf.d/nix.fish"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

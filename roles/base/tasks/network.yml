---
# =============================================================================
# Network Configuration
# =============================================================================

- name: Detect if running in VirtualBox
  ansible.builtin.set_fact:
    is_virtualbox: "{{ ansible_product_name | default('') is search('VirtualBox') or ansible_system_vendor | default('') is search('innotek') }}"

- name: Get primary network interface
  ansible.builtin.shell: |
    ip route | grep default | awk '{print $5}' | head -1
  register: primary_interface
  changed_when: false

- name: Configure static IP for VirtualBox VM
  ansible.builtin.copy:
    content: |
      # Static IP configuration for VirtualBox VM
      # Generated by Ansible
      ip link set {{ primary_interface.stdout }} up
      ip addr add 192.168.0.100/24 dev {{ primary_interface.stdout }}
      ip route add default via 192.168.0.1
    dest: /etc/dhcpcd.exit-hook
    mode: '0755'
  when: is_virtualbox | bool
  notify: Restart dhcpcd

- name: Configure dhcpcd for static IP on VM
  ansible.builtin.blockinfile:
    path: /etc/dhcpcd.conf
    block: |
      # Static IP for VirtualBox VM
      interface {{ primary_interface.stdout }}
      static ip_address=192.168.0.100/24
      static routers=192.168.0.1
      static domain_name_servers=192.168.0.1 8.8.8.8
    marker: "# {mark} ANSIBLE MANAGED - STATIC IP"
    create: yes
  when: is_virtualbox | bool
  notify: Restart dhcpcd

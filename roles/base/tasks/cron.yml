---
# =============================================================================
# Cron Jobs Configuration (using cronie)
# =============================================================================

- name: Install cronie
  ansible.builtin.command:
    cmd: xbps-install -Sy cronie
  changed_when: true

- name: Enable cronie service
  ansible.builtin.file:
    src: /etc/sv/cronie
    dest: /var/service/cronie
    state: link

- name: Create void-update script for weekly updates
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Void Linux weekly update script
      # Logs updates for review if something breaks

      set -e

      LOG_DIR="/var/log/void-updates"
      DATE=$(date '+%Y-%m-%d_%H%M')
      LOG_FILE="$LOG_DIR/update-$DATE.log"

      mkdir -p "$LOG_DIR"

      echo "=== Void Linux Update - $DATE ===" > "$LOG_FILE"
      echo "" >> "$LOG_FILE"

      # Save current package versions
      echo "=== Pre-update package list ===" >> "$LOG_FILE"
      xbps-query -l >> "$LOG_FILE"
      echo "" >> "$LOG_FILE"

      # Update system
      echo "=== Running xbps-install -Syu ===" >> "$LOG_FILE"
      xbps-install -Syu >> "$LOG_FILE" 2>&1

      # Clean old packages
      echo "=== Cleaning old packages ===" >> "$LOG_FILE"
      xbps-remove -Oo >> "$LOG_FILE" 2>&1 || true

      # Remove old kernels
      echo "=== Removing old kernels ===" >> "$LOG_FILE"
      vkpurge rm all >> "$LOG_FILE" 2>&1 || true

      # Update Nix packages if installed
      if command -v nix-env >/dev/null 2>&1; then
          echo "=== Updating Nix packages ===" >> "$LOG_FILE"
          nix-channel --update >> "$LOG_FILE" 2>&1 || true
          nix-env -u >> "$LOG_FILE" 2>&1 || true
          nix-collect-garbage -d >> "$LOG_FILE" 2>&1 || true
      fi

      # Update Flatpak if installed
      if command -v flatpak >/dev/null 2>&1; then
          echo "=== Updating Flatpak ===" >> "$LOG_FILE"
          flatpak update -y >> "$LOG_FILE" 2>&1 || true
          flatpak uninstall --unused -y >> "$LOG_FILE" 2>&1 || true
      fi

      # Update maza blocklist
      if [ -x /usr/local/bin/maza ]; then
          echo "=== Updating maza blocklist ===" >> "$LOG_FILE"
          /usr/local/bin/maza update >> "$LOG_FILE" 2>&1 || true
      fi

      echo "" >> "$LOG_FILE"
      echo "=== Update completed at $(date) ===" >> "$LOG_FILE"

      # Keep only last 10 update logs
      ls -t "$LOG_DIR"/update-*.log 2>/dev/null | tail -n +11 | xargs -r rm
    dest: /usr/local/bin/void-update.sh
    mode: '0755'

- name: Create cron directory
  ansible.builtin.file:
    path: /etc/cron.d
    state: directory
    mode: '0755'

- name: Setup weekly update cron job (Saturday 3 AM)
  ansible.builtin.copy:
    content: |
      # Weekly system update - Saturday at 3:00 AM
      0 3 * * 6 root /usr/local/bin/void-update.sh
    dest: /etc/cron.d/void-update
    mode: '0644'

- name: Setup daily TRIM cron job (4 AM)
  ansible.builtin.copy:
    content: |
      # Daily TRIM for SSDs - 4:00 AM
      0 4 * * * root /usr/bin/fstrim -av >> /var/log/fstrim.log 2>&1
    dest: /etc/cron.d/fstrim
    mode: '0644'

- name: Setup daily maza update (5 AM)
  ansible.builtin.copy:
    content: |
      # Daily maza ad-block update - 5:00 AM
      0 5 * * * root /usr/local/bin/maza-update.sh
    dest: /etc/cron.d/maza
    mode: '0644'

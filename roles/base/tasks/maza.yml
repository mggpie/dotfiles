---
# =============================================================================
# Maza Ad-Blocking Setup
# https://maza-ad-blocking.andros.dev/
# =============================================================================

- name: Install maza dependencies
  ansible.builtin.command:
    cmd: xbps-install -Sy curl
  changed_when: true

- name: Download maza script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/tanrax/maza-ad-blocking/master/maza
    dest: /usr/local/bin/maza
    mode: '0755'

- name: Create maza update script
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Maza ad-blocking update script
      # Updates the hosts file with latest blocklist

      set -e

      LOG_FILE="/var/log/maza.log"

      echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting maza update" >> "$LOG_FILE"

      # Update maza blocklist
      /usr/local/bin/maza update >> "$LOG_FILE" 2>&1

      # Ensure maza is started (modifies /etc/hosts)
      /usr/local/bin/maza start >> "$LOG_FILE" 2>&1

      echo "$(date '+%Y-%m-%d %H:%M:%S') - Maza update completed" >> "$LOG_FILE"
    dest: /usr/local/bin/maza-update.sh
    mode: '0755'

- name: Initialize maza (first run)
  ansible.builtin.command:
    cmd: /usr/local/bin/maza update
  changed_when: true
  failed_when: false

- name: Start maza ad-blocking
  ansible.builtin.command:
    cmd: /usr/local/bin/maza start
  changed_when: true
  failed_when: false

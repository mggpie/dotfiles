---
# =============================================================================
# CPU Microcode Installation
# =============================================================================

- name: Install Intel microcode
  ansible.builtin.command:
    cmd: xbps-install -Sy intel-ucode
  when: cpu_vendor == 'intel'
  changed_when: true

- name: Install AMD microcode
  ansible.builtin.command:
    cmd: xbps-install -Sy linux-firmware-amd
  when: cpu_vendor == 'amd'
  changed_when: true

- name: Regenerate initramfs to include microcode
  ansible.builtin.command:
    cmd: xbps-reconfigure -f linux{{ ansible_kernel.split('.')[0] }}.{{ ansible_kernel.split('.')[1] }}
  changed_when: true
  failed_when: false

- name: Regenerate initramfs (fallback)
  ansible.builtin.command:
    cmd: dracut --force
  changed_when: true
  when: false  # Enable if above fails

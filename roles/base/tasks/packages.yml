---
# =============================================================================
# Base Packages Installation
# =============================================================================

- name: Install base packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ base_packages | join(' ') }}"
  changed_when: true

# Enable elogind for XDG_RUNTIME_DIR (required for Wayland)
- name: Enable dbus service
  ansible.builtin.file:
    src: /etc/sv/dbus
    dest: /var/service/dbus
    state: link

- name: Enable elogind service
  ansible.builtin.file:
    src: /etc/sv/elogind
    dest: /var/service/elogind
    state: link

# Note: Fonts are installed via Nix in the nix role

# Graphics drivers - detect VM vs bare metal
- name: Detect if running in VirtualBox
  ansible.builtin.set_fact:
    is_virtualbox: "{{ ansible_product_name | default('') is search('VirtualBox') or ansible_system_vendor | default('') is search('innotek') }}"

- name: Install VirtualBox Guest Additions (VM)
  ansible.builtin.command:
    cmd: "xbps-install -Sy virtualbox-ose-guest virtualbox-ose-guest-dkms"
  when: is_virtualbox | bool
  changed_when: true

- name: Enable VirtualBox services (VM)
  ansible.builtin.file:
    src: /etc/sv/{{ item }}
    dest: /var/service/{{ item }}
    state: link
  loop:
    - vboxservice
  when: is_virtualbox | bool
  ignore_errors: true

- name: Install graphics packages (Intel - bare metal only)
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ graphics_packages | join(' ') }}"
  when: not (is_virtualbox | bool)
  changed_when: true

- name: Update font cache
  ansible.builtin.command:
    cmd: fc-cache -fv
  changed_when: true

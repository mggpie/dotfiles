---
# =============================================================================
# doas Configuration (sudo replacement)
# =============================================================================

- name: Install doas
  ansible.builtin.command:
    cmd: xbps-install -Sy opendoas
  changed_when: true

- name: Create doas.d directory
  ansible.builtin.file:
    path: /etc/doas.d
    state: directory
    mode: '0755'

- name: Configure doas for user (passwordless)
  ansible.builtin.copy:
    content: |
      # doas configuration for {{ username }}
      # Allow {{ username }} to run any command without password
      permit nopass {{ username }}

      # Allow wheel group with password (fallback)
      permit persist :wheel
    dest: /etc/doas.d/doas.conf
    mode: '0600'
    owner: root
    group: root

- name: Verify doas configuration
  ansible.builtin.command:
    cmd: doas -C /etc/doas.d/doas.conf
  register: doas_check
  changed_when: false
  failed_when: doas_check.rc != 0

- name: Create sudo -> doas symlink (compatibility)
  ansible.builtin.file:
    src: /usr/bin/doas
    dest: /usr/local/bin/sudo
    state: link
  failed_when: false

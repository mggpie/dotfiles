---
# =============================================================================
# Development Tools Role
# =============================================================================

- name: Install development packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ dev_packages | join(' ') }}"
  changed_when: true

- name: Install virtualization packages
  ansible.builtin.command:
    cmd: "xbps-install -Sy {{ virt_packages | join(' ') }}"
  changed_when: true

# Docker setup
- name: Enable docker service
  ansible.builtin.file:
    src: /etc/sv/docker
    dest: /var/service/docker
    state: link
  failed_when: false

- name: Add user to docker group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: docker
    append: true

# Libvirt/KVM setup
- name: Enable libvirtd service
  ansible.builtin.file:
    src: /etc/sv/libvirtd
    dest: /var/service/libvirtd
    state: link
  failed_when: false

- name: Enable virtlockd service
  ansible.builtin.file:
    src: /etc/sv/virtlockd
    dest: /var/service/virtlockd
    state: link
  failed_when: false

- name: Add user to libvirt and kvm groups
  ansible.builtin.user:
    name: "{{ username }}"
    groups: libvirt,kvm
    append: true

# Python development
- name: Install Python development tools
  ansible.builtin.command:
    cmd: pip3 install --user black flake8 mypy pylint pytest ipython
  become: true
  become_user: "{{ username }}"
  changed_when: true
  failed_when: false

# Install ansible-lint
- name: Install ansible-lint
  ansible.builtin.command:
    cmd: pip3 install --user ansible-lint yamllint
  become: true
  become_user: "{{ username }}"
  changed_when: true
  failed_when: false

# Git configuration
- name: Configure git
  become: true
  become_user: "{{ username }}"
  ansible.builtin.copy:
    content: |
      [user]
          name = {{ username }}
          # email = your@email.com  # Set in vault

      [init]
          defaultBranch = main

      [core]
          editor = {{ editor }}
          autocrlf = input

      [pull]
          rebase = false

      [alias]
          st = status
          co = checkout
          br = branch
          ci = commit
          lg = log --oneline --graph --all

      [color]
          ui = auto
    dest: "{{ user_home }}/.gitconfig"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

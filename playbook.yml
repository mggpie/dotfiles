---
# =============================================================================
# Void Linux Post-Install Playbook
# =============================================================================
# Run: ansible-playbook -i hosts playbook.yml
# Tags: ansible-playbook -i hosts playbook.yml --tags fish
# =============================================================================

- name: Configure Void Linux
  hosts: all
  become: true
  vars_files:
    - vars.yml

  pre_tasks:
    - name: Detect CPU vendor for microcode
      set_fact:
        cpu_vendor: "{{ 'intel' if 'GenuineIntel' in ansible_processor else 'amd' }}"
      tags: always

  tasks:
    # =========================================================================
    # BASE SYSTEM
    # =========================================================================
    - name: Install base packages
      community.general.xbps:
        name: "{{ base_packages }}"
        state: present
      tags: [base, packages]

    - name: Configure doas (passwordless for wheel)
      copy:
        content: |
          permit nopass :wheel
          permit nopass {{ username }} as root
        dest: /etc/doas.conf
        mode: '0400'
      tags: [base, doas]

    - name: Set timezone
      file:
        src: "/usr/share/zoneinfo/{{ timezone }}"
        dest: /etc/localtime
        state: link
        force: yes
      tags: [base, locale]

    - name: Configure locale
      copy:
        content: "{{ locale }}"
        dest: /etc/locale.conf
      tags: [base, locale]

    - name: Enable locale in libc-locales
      lineinfile:
        path: /etc/default/libc-locales
        regexp: "^#?{{ locale }}"
        line: "{{ locale }} UTF-8"
      tags: [base, locale]

    - name: Regenerate locales
      command: xbps-reconfigure -f glibc-locales
      changed_when: true
      tags: [base, locale]

    - name: Set keyboard layout
      copy:
        content: "KEYMAP={{ keymap }}"
        dest: /etc/vconsole.conf
      tags: [base, locale]

    - name: Install CPU microcode
      community.general.xbps:
        name: "{{ 'intel-ucode' if cpu_vendor == 'intel' else 'linux-firmware-amd' }}"
        state: present
      tags: [base, microcode]

    - name: Create user with groups
      user:
        name: "{{ username }}"
        shell: "{{ default_shell }}"
        groups: "{{ user_groups }}"
        append: yes
      tags: [base, user]

    - name: Configure XDG user directories
      copy:
        content: |
          XDG_DESKTOP_DIR="$HOME/Desktop"
          XDG_DOWNLOAD_DIR="$HOME/Downloads"
          XDG_TEMPLATES_DIR="$HOME/Templates"
          XDG_PUBLICSHARE_DIR="$HOME/Public"
          XDG_DOCUMENTS_DIR="$HOME/Documents"
          XDG_MUSIC_DIR="$HOME/Music"
          XDG_PICTURES_DIR="$HOME/Pictures"
          XDG_VIDEOS_DIR="$HOME/Videos"
        dest: "{{ user_home }}/.config/user-dirs.dirs"
        owner: "{{ username }}"
        group: "{{ username }}"
      tags: [base, xdg]

    - name: Prevent xdg-user-dirs from overwriting
      copy:
        content: "enabled=False"
        dest: "{{ user_home }}/.config/user-dirs.conf"
        owner: "{{ username }}"
        group: "{{ username }}"
      tags: [base, xdg]

    - name: Create XDG directories
      file:
        path: "{{ user_home }}/{{ item }}"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"
      loop:
        - Desktop
        - Downloads
        - Documents
        - Music
        - Pictures
        - Videos
      tags: [base, xdg]

    - name: Configure auto-login on TTY1
      copy:
        content: |
          #!/bin/sh
          # Create XDG_RUNTIME_DIR before login
          [ -d /run/user/$(id -u {{ username }}) ] || {
              mkdir -p /run/user/$(id -u {{ username }})
              chown {{ username }}:{{ username }} /run/user/$(id -u {{ username }})
              chmod 0700 /run/user/$(id -u {{ username }})
          }
          exec /sbin/agetty --autologin {{ username }} --noclear tty1 linux
        dest: /etc/sv/agetty-tty1/run
        mode: '0755'
      tags: [base, autologin]

    - name: Disable TTY 3-6 (keep only 1-2)
      file:
        path: "/var/service/agetty-tty{{ item }}"
        state: absent
      loop: [3, 4, 5, 6]
      tags: [base, tty]

    - name: Enable base services
      file:
        src: "/etc/sv/{{ item }}"
        dest: "/var/service/{{ item }}"
        state: link
      loop:
        - chronyd
        - dbus
        - elogind
        - seatd
        - cronie
      tags: [base, services]

    - name: Disable SSH on bare metal (enable on VM only)
      file:
        path: /var/service/sshd
        state: "{{ 'link' if ansible_virtualization_role == 'guest' else 'absent' }}"
        src: "{{ '/etc/sv/sshd' if ansible_virtualization_role == 'guest' else omit }}"
      tags: [base, ssh]

    # =========================================================================
    # SHELL (Fish + Tide)
    # =========================================================================
    - name: Install shell packages
      community.general.xbps:
        name: "{{ shell_packages }}"
        state: present
      tags: [shell, fish]

    - name: Install Tide prompt for Fish
      become_user: "{{ username }}"
      shell: fish -c "fisher install IlanCosman/tide@v6"
      args:
        creates: "{{ user_home }}/.config/fish/functions/tide.fish"
      tags: [shell, fish, tide]

    - name: Configure Tide (2 Spaced, Rainbow, Transient)
      become_user: "{{ username }}"
      shell: |
        fish -c "tide configure --auto --style=Rainbow --prompt_colors='True color' --show_time='24-hour format' --rainbow_prompt_separators=Angled --powerline_prompt_heads=Sharp --powerline_prompt_tails=Flat --powerline_prompt_style='Two lines, character and frame' --prompt_connection=Solid --powerline_right_prompt_frame=No --prompt_connection_andor_frame_color=Darkest --prompt_spacing=Spaced --icons='Many icons' --transient=Yes"
      changed_when: true
      tags: [shell, fish, tide]

    # =========================================================================
    # WAYLAND (Sway + Waybar + Foot)
    # =========================================================================
    - name: Install Wayland packages
      community.general.xbps:
        name: "{{ wayland_packages }}"
        state: present
      tags: [wayland, packages]

    - name: Install graphics drivers (Intel)
      community.general.xbps:
        name: "{{ graphics_packages }}"
        state: present
      when: cpu_vendor == 'intel'
      tags: [wayland, graphics]

    - name: Create Sway config directory
      file:
        path: "{{ user_home }}/.config/sway"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"
      tags: [wayland, sway]

    - name: Copy default Sway config
      copy:
        src: /etc/sway/config
        dest: "{{ user_home }}/.config/sway/config"
        owner: "{{ username }}"
        group: "{{ username }}"
        remote_src: yes
        force: no
      tags: [wayland, sway]

    - name: Create Waybar config directory
      file:
        path: "{{ user_home }}/.config/waybar"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"
      tags: [wayland, waybar]

    - name: Copy default Waybar config
      copy:
        src: "/etc/xdg/waybar/{{ item }}"
        dest: "{{ user_home }}/.config/waybar/{{ item }}"
        owner: "{{ username }}"
        group: "{{ username }}"
        remote_src: yes
        force: no
      loop:
        - config
        - style.css
      failed_when: false
      tags: [wayland, waybar]

    - name: Create Foot config directory
      file:
        path: "{{ user_home }}/.config/foot"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"
      tags: [wayland, foot]

    - name: Copy default Foot config
      copy:
        src: /etc/xdg/foot/foot.ini
        dest: "{{ user_home }}/.config/foot/foot.ini"
        owner: "{{ username }}"
        group: "{{ username }}"
        remote_src: yes
        force: no
      failed_when: false
      tags: [wayland, foot]

    - name: Add Fish auto-start Sway on TTY1
      blockinfile:
        path: "{{ user_home }}/.config/fish/config.fish"
        create: yes
        owner: "{{ username }}"
        group: "{{ username }}"
        marker: "# {mark} ANSIBLE MANAGED - Sway autostart"
        block: |
          # Auto-start Sway on TTY1
          if status is-login
              if test -z "$WAYLAND_DISPLAY" && test "$XDG_VTNR" = "1"
                  exec sway
              end
          end
      tags: [wayland, sway, autostart]

    # =========================================================================
    # AUDIO (PipeWire + Bluetooth)
    # =========================================================================
    - name: Install audio packages
      community.general.xbps:
        name: "{{ audio_packages }}"
        state: present
      tags: [audio, pipewire]

    - name: Install Bluetooth packages
      community.general.xbps:
        name: "{{ bluetooth_packages }}"
        state: present
      tags: [audio, bluetooth]

    - name: Enable Bluetooth service
      file:
        src: /etc/sv/bluetoothd
        dest: /var/service/bluetoothd
        state: link
      tags: [audio, bluetooth]

    # =========================================================================
    # APPLICATIONS
    # =========================================================================
    - name: Install user applications
      community.general.xbps:
        name: "{{ user_apps }}"
        state: present
      tags: [apps]

    - name: Install development tools
      community.general.xbps:
        name: "{{ dev_packages }}"
        state: present
      tags: [dev]

    - name: Install virtualization packages
      community.general.xbps:
        name: "{{ virt_packages }}"
        state: present
      tags: [virt]

    - name: Enable Docker service
      file:
        src: /etc/sv/docker
        dest: /var/service/docker
        state: link
      tags: [dev, docker]

    - name: Enable libvirtd service
      file:
        src: /etc/sv/libvirtd
        dest: /var/service/libvirtd
        state: link
      tags: [virt]

    # =========================================================================
    # NIX PACKAGE MANAGER
    # =========================================================================
    - name: Check if Nix is installed
      stat:
        path: /nix
      register: nix_check
      tags: [nix]

    - name: Install Nix (stable, multi-user)
      shell: |
        curl -L https://nixos.org/nix/install | sh -s -- --daemon
      when: not nix_check.stat.exists
      tags: [nix]

    - name: Install packages from Nix
      become_user: "{{ username }}"
      shell: |
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        nix-env -iA nixpkgs.{{ item }}
      loop:
        - vscode
        - wezterm
      when: not nix_check.stat.exists
      tags: [nix]

    # =========================================================================
    # SYSTEM TWEAKS
    # =========================================================================
    - name: Install power management
      community.general.xbps:
        name: "{{ power_packages }}"
        state: present
      tags: [tweaks, power]

    - name: Enable TLP service
      file:
        src: /etc/sv/tlp
        dest: /var/service/tlp
        state: link
      tags: [tweaks, power]

    - name: Create system update script
      copy:
        content: |
          #!/bin/sh
          set -e
          echo "$(date): Starting system update" >> /var/log/void-update.log
          xbps-install -Su >> /var/log/void-update.log 2>&1
          echo "$(date): Update complete" >> /var/log/void-update.log
        dest: /usr/local/bin/void-update.sh
        mode: '0755'
      tags: [tweaks, updates]

    - name: Setup cron jobs
      cron:
        name: "{{ item.name }}"
        minute: "{{ item.minute | default('*') }}"
        hour: "{{ item.hour | default('*') }}"
        weekday: "{{ item.weekday | default('*') }}"
        job: "{{ item.job }}"
        user: root
      loop: "{{ cron_jobs }}"
      tags: [tweaks, cron]

    - name: Download Maza ad-blocking script
      get_url:
        url: https://raw.githubusercontent.com/tanrax/maza-ad-blocking/master/maza
        dest: /usr/local/bin/maza
        mode: '0755'
      tags: [tweaks, maza]

    - name: Initialize Maza
      command: /usr/local/bin/maza update
      changed_when: true
      failed_when: false
      tags: [tweaks, maza]

    - name: Start Maza ad-blocking
      command: /usr/local/bin/maza start
      changed_when: true
      failed_when: false
      tags: [tweaks, maza]

  post_tasks:
    - name: Reconfigure all packages
      command: xbps-reconfigure -fa
      changed_when: true
      tags: always

    - name: Display completion message
      debug:
        msg: |
          ===================================
          Void Linux setup complete!
          
          Reboot and login as {{ username }}
          Sway will start automatically on TTY1
          ===================================
      tags: always
